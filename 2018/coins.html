<body id=b style=margin:0>
<canvas id=a></canvas>
<script>
d = document;
c = a.getContext("2d");
a.width = innerWidth;
a.height = innerHeight;

con = console;

sw = innerWidth;
sh = innerHeight;
f = .5 // just a half
J = 250; // no of objects
F = .99; // friction
v = [];
u = Math.PI*2

R = (min, max) => min + Math.random() * (max - min);
s = i => Math.abs(i)

C = _ => { // create coin
	O = ~~R(3,6) // coin size
	v.push({
		mx: R(-f,f),
		my: R(-f,f),
		mmx: 0,
		mmy: 0,
		r: O ** 2,
		x: R(0, sw),
		y: R(0, -sh),
		colour: [
		"#aaa",
		"#c81",
		"#da4",
		][O-3]
	})
}

for(i=0;i++<J;)C()

n = _ => { // pacman
	rr = R(3,15) ** 2
	p = {
		r: rr,
		y: sh - rr,
		x: -rr
	}
}
n()

h = (a,b) => { // distance
	dx = a.x - b.x;
	dy = a.y - b.y;
	d = Math.hypot(dx,dy) + 1/1e5;
	return {dx,dy,d}
}



e = t => { // render
	requestAnimationFrame(e);
	c.fillStyle = "#000"
	c.fillRect(0,0,sw,sh)

	v.length < J && R(0,1) > .8 && C();
	(p.x += 5) > sw + p.r && n()

	v = v.filter((b,i)=>{
	  	v.slice(i).map(o=>{
	  		var {dx,dy,d} = h(b, o);
			r = b.r + o.r;
			if (d < r) { // ok, let's bounce
				m = r / d * 9;
				ux = m * dx / d;
				uy = m * dy / d;

				b.mx += ux / b.r;
				b.my += uy / b.r;

				o.mx -= ux / o.r;
				o.my -= uy / o.r;
			}

		});

		b.mx *= F;
		b.my += .1; // gravity
		b.my *= F;

		c.fillStyle = b.colour;
		c.beginPath();
		c.arc(b.x, b.y, b.r, 0, u, 0);
		c.fill();

		c.font=`${b.r}px Verdana`;
		c.fillStyle = "#000";
		z=b.r/4;
		c.fillText("$", b.x-z, b.y+z);

		return !(h(b, p).d < b.r + p.r); // decide if it's eaten by pacman
	});

	v.map(b => {
		if ( b.x < b.r ) b.mx = s(b.mx);
		if ( b.x > sw - b.r ) b.mx = -s(b.mx);
		if ( b.y > sh - b.r ) b.my = -s(b.my); // bouncey Os
		b.mmx -= (b.mmx - b.mx) * f;
		b.mmy -= (b.mmy - b.my) * f;
		b.x += b.mmx;
		b.y += b.mmy;
	});

	// draw mouth
	ang = Math.sin(t/99)
	c.fillStyle = "#ff0";
	c.beginPath();
	c.arc(p.x, p.y, p.r, ang, u - ang, 0);
	c.lineTo(p.x, p.y) // draw mouth
	c.fill();

}
e();

</script>
